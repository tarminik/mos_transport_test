# Система сбора инцидентов

Это веб-приложение на Flask, предназначенное для сбора и поиска данных об инцидентах.

## Стек технологий

- **Бэкенд**: Python, Flask, Flask-RESTful, Gunicorn
- **База данных**: PostgreSQL
- **Контейнеризация**: Docker, Docker Compose

## Структура API

### 1. Сохранение инцидента

- **URL**: `/problems`
- **Метод**: `POST`
- **Описание**: Принимает JSON-тело и заголовки запроса, сохраняет их в базу данных и возвращает SHA-256 хеш от этих данных. Хеш не зависит от порядка ключей в JSON.
- **Тело запроса**: Любой валидный JSON.
- **Пример ответа**:
  ```json
  {
    "hash": "a1b2c3d4e5f6..."
  }
  ```

### 2. Поиск по ключу и значению

- **URL**: `/find`
- **Метод**: `POST`
- **Описание**: Ищет инциденты, у которых в заголовках или в теле есть совпадение по хотя бы одной паре "ключ-значение" из запроса.
- **Тело запроса**: JSON с ключами и значениями для поиска.
- **Пример запроса**:
  ```json
  {
    "user_id": 123,
    "status": "error"
  }
  ```
- **Пример ответа**:
  ```json
  {
    "results": [
      {
        "id": 1,
        "headers": { "...": "..." },
        "body": { "user_id": 123, "details": "..." },
        "hash": "a1b2c3d4e5f6..."
      }
    ]
  }
  ```

### 3. Поиск по хешу

- **URL**: `/find2`
- **Метод**: `GET`
- **Описание**: Возвращает все инциденты с указанным хешем.
- **Параметры запроса**: `h` - хеш для поиска.
- **Пример запроса**: `GET /find2?h=a1b2c3d4e5f6...`
- **Пример ответа**:
  ```json
  {
    "results": [
      {
        "id": 1,
        "headers": { "...": "..." },
        "body": { "...": "..." },
        "hash": "a1b2c3d4e5f6..."
      }
    ]
  }
  ```

## Инструкция по развертыванию

### Требования

- Docker
- Docker Compose

### Запуск

1.  **Склонируйте репозиторий**:
    ```bash
    git clone https://github.com/tarminik/mos_transport_test
    cd mos_transport_test
    ```

2.  **Запустите приложение с помощью Docker Compose**:
    Эта команда соберет образ для веб-приложения, запустит контейнеры для приложения и базы данных PostgreSQL, и все это в фоновом режиме.
    ```bash
    docker-compose up -d --build
    ```
    Приложение будет доступно по адресу `http://localhost:5000`.

### Проверка работы

Вы можете использовать `curl` для проверки работы API.

1.  **Создать инцидент**:
    ```bash
    curl -X POST http://localhost:5000/problems \
    -H "Content-Type: application/json" \
    -H "X-Client-ID: my-app" \
    -d '{"event": "user_login_failed", "reason": "wrong_password"}'
    ```
    Сохраните полученный хеш для следующих запросов.

2.  **Найти по хешу**:
    ```bash
    curl http://localhost:5000/find2?h=<ВАШ_ХЕШ>
    ```

3.  **Найти по содержимому**:
    ```bash
    curl -X POST http://localhost:5000/find \
    -H "Content-Type: application/json" \
    -d '{"event": "user_login_failed"}'
    ```

### Остановка приложения

Чтобы остановить все запущенные контейнеры, выполните:
```bash
docker-compose down
```
